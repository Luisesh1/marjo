wb = xlsx_package.workbook
    @linea = 0
    @avance = 0
    @fecha="2019/04/27"
def llenar_fila(creditos,nombre)
     payments =creditos.joins(:payments)
        cartera1 = payments.sum(:importe)-payments.joins(:payments=>:tickets).where("tickets.status = ? and tickets.updated_at< ?", 0,'2019/04/26').sum(:cantidad)
        colocado=payments.where("payments.created_at>= ?", @fecha).sum(:importe)
        cant_corrxcobrar = payments.where("estatus = ? and payments.fecha_de_corte<= ?", 0, @fecha).count
        imp_corrxcobrar = payments.where("estatus = ? and payments.fecha_de_corte<= ?", 0,@fecha).sum(:importe)       
        #cant_corr_cobrado = payments.joins(:payments=>:tickets).where("tickets.status = ? and tickets.updated_at> ?", 0,@fecha).count
        cant_corr_cobrado = payments.joins(:payments=>:tickets).where("payments.estatus = ? and tickets.updated_at> ?", 0,@fecha).count
        imp_corr_cobrado = payments.joins(:payments=>:tickets).where("tickets.status = ? and tickets.updated_at> ?", 0,@fecha).sum(:cantidad)
        cant_atrasxcobrar =  payments.where("payments.vencimientos > ? and payments.fecha_de_pago> ?",0,@fecha).count 
        imp_atrasxcobrar =  payments.where("payments.vencimientos> ? and payments.fecha_de_pago> ?",0, @fecha).sum(:importe)
        cant_atras_cobrado =  payments.joins(:payments=>:tickets).where("tickets.status = ? and tickets.updated_at> ? and vencimientos> ?", 1,@fecha,0).count
        imp_atras_cobrado =  payments.joins(:payments=>:tickets).where("tickets.status = ? and tickets.updated_at> ? and vencimientos> ?", 1,@fecha,0).sum(:cantidad)
        cant_vencxcobrar =   payments.where("payments.estatus = ? and fecha_de_pago<= ?",1,@fecha).count
        imp_vencxcobrar =  payments.where("payments.estatus = ? and fecha_de_pago<= ?",1,@fecha).sum(:importe)
        cant_venc_cobrado =  payments.where("payments.estatus = ? and fecha_de_pago>= ?",1,@fecha).count
        imp_venc_cobrado =  payments.where("payments.estatus = ? and fecha_de_pago>= ?",1,@fecha).sum(:importe)
        
        return [
                nombre,
                cartera1,
                colocado,
                cant_corrxcobrar,
                imp_corrxcobrar,
                cant_corr_cobrado,
                imp_corr_cobrado,
                cant_atrasxcobrar,
                imp_atrasxcobrar,
                cant_atras_cobrado,
                imp_atras_cobrado,
                cant_vencxcobrar,
                imp_vencxcobrar,
                cant_venc_cobrado,
                imp_venc_cobrado
                ]
   
end



wb.add_worksheet(name: "numeros_tablero") do |sheet|
    wb.styles do |style|
    highlight_cell = style.add_style(bg_color: "F4A460")
    border = wb.styles.add_style({:border => { :style => :thin, :color => "000000" }}) 
    
    title = wb.styles.add_style(:bg_color => "F4A460",
                           :fg_color=>"#FF000000",
                           :border=>Axlsx::STYLE_THIN_BORDER,
                           :alignment=>{:horizontal => :center})
                           
    linea = wb.styles.add_style(:bg_color => "F4A460",
                           :fg_color=>"#FF000000",
                           :alignment=>{:horizontal => :center})

    currency = wb.styles.add_style(:format_code=>"#,##0;[Red]-#,##0",
                              :border=>Axlsx::STYLE_THIN_BORDER)
    
    sheet.add_row ["FINANCIERA MARJO, S.A. DE C.V., SOFOM, E.N.R."]
    sheet.add_row ["NÃšMEROS TABLERO"]
    sheet.add_row [@fecha] 
    sheet.add_row ["","","","","CORRIENTE","","","","ATRASADOS","","","","","VENCIDOS",""],:style=>[title,title,title,title,title,title,title,title,title,title,title,title,title,title,title]
    sheet.add_row ["AGENTE","CARTERA","COLOCADO","POR COBRAR","","COBRADO","","POR COBRAR","","COBRADO","","POR COBRAR","","COBRADO"," "],:style=>[title,title,title,linea,title,linea,linea,linea,linea,linea,linea,linea,linea,linea,linea]
    sheet.add_row ["","","","No.","MONTO","No.","MONTO","No.","MONTO","No.","MONTO","No.","MONTO","No.","MONTO"],:style=>[title,title,title,title,title,title,title,title,title,title,title,title,title,title,title]
    @linea = 7
    @sucursales.each do |sucursal|
        @linea = @linea+@avance
        @avance = 0
        sucursal.agents.each do |agente|
            creditos = agente.credits.where("credits.status = ?",1)
            sheet.add_row llenar_fila(creditos,agente.nombre_completo),:style=>[currency, currency,currency,currency, currency,currency,currency, currency,currency,currency, currency,currency,currency, currency,currency]
            @avance += 1
        end

    end
    end
end